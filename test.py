from core.bark import generate_audio, generation_config, load_bark_audio_prompt
from core.bark.generate_coarse import generate_coarse_tokens_from_semantic
from core.bark.generate_fine import generate_fine_tokens_from_coarse
from core.bark.data_types import BarkPrompt
import torch

from dataclasses import asdict

semantic_tokens = [
    [
        302,
        147,
        4006,
        57,
        5854,
        8103,
        8103,
        2201,
        3154,
        1538,
        5411,
        4240,
        4240,
        4240,
        4725,
        857,
        857,
        1732,
        3896,
        2536,
        3896,
        3896,
        3896,
        9471,
        9471,
        1841,
        147,
        10,
        9342,
        9342,
        9342,
        9342,
        9342,
        206,
        147,
        5428,
        528,
        2009,
        4917,
        147,
        147,
        209,
        2086,
        2086,
        2086,
        2086,
        2086,
        2086,
        2086,
        441,
        441,
        9342,
        9342,
        4917,
        5428,
        528,
        528,
        528,
        528,
        5428,
        1613,
        5428,
        528,
        1613,
        528,
        1613,
        5428,
        2009,
        2009,
        2096,
        2009,
        147,
        602,
        209,
        209,
        5051,
        958,
        402,
        10,
        402,
        6774,
        1913,
        8020,
        8572,
        6241,
        59,
        28,
        107,
        9284,
        7695,
        7695,
        4133,
        92,
        92,
        148,
        4093,
        4093,
        6259,
        210,
        210,
        10,
        5,
        265,
        2187,
        6021,
        8686,
        2656,
        9245,
        9623,
        6469,
        620,
        59,
        28,
        28,
        107,
        5331,
        196,
        10,
        5,
        2187,
        8686,
        2656,
        4706,
        3941,
        8141,
        2033,
        15,
        15,
        27,
        27,
        10,
        27,
        1382,
        59,
        28,
        31,
        31,
        196,
        196,
        583,
        4045,
        2465,
        1206,
        131,
        147,
        1206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        206,
        2009,
        206,
        2228,
        206,
        2009,
        206,
        206,
        2009,
        2659,
        2009,
        5428,
        2009,
        6340,
        2009,
        2009,
    ]
]
semantic_prompt = [
    65,
    65,
    65,
    65,
    65,
    65,
    147,
    147,
    302,
    302,
    147,
    7372,
    302,
    8103,
    2201,
    2201,
    1538,
    2201,
    1538,
    1538,
    1538,
    857,
    857,
    857,
    857,
    857,
    857,
    1732,
    8929,
    8929,
    8929,
    10,
    441,
    209,
    209,
    1620,
    958,
    402,
    41,
    483,
    9968,
    5839,
    3177,
    1493,
    1493,
    8036,
    5173,
    4203,
    292,
    41,
    927,
    2792,
    2559,
    2559,
    9804,
    298,
    298,
    6496,
    880,
    5376,
    59,
    27,
    884,
    2599,
    4478,
    7503,
    1092,
    41,
    321,
    2534,
    92,
    92,
    148,
    7473,
    7891,
    8029,
    1819,
    366,
    50,
    10,
    100,
    6921,
    8158,
    8158,
    8631,
    178,
    211,
    210,
    5,
    5,
    3555,
    1027,
    1027,
    412,
    412,
    9848,
    1044,
    50,
    27,
    27,
    5587,
    6446,
    41,
    41,
    2768,
    4712,
    4712,
    4655,
    520,
    704,
    704,
    1997,
    3280,
    741,
    741,
    10,
    7311,
    5669,
    1265,
    402,
    402,
    402,
    402,
    402,
    10,
    41,
    105,
    1751,
    3849,
    3849,
    3849,
    430,
    430,
    430,
    430,
    169,
    3063,
    4251,
    1755,
    959,
    232,
    10,
    131,
    5647,
    5647,
    3387,
    602,
    10,
    3387,
    602,
    147,
    147,
    4751,
    4917,
    147,
    528,
    206,
    528,
    56,
    5428,
    206,
    2096,
    1613,
    147,
    2009,
    2009,
    2096,
    4951,
    147,
    4006,
    302,
    2074,
    9817,
    3589,
    7282,
    648,
    429,
    429,
    8448,
    8024,
    8024,
    8631,
    171,
    210,
    10,
    27,
    399,
    4039,
    6588,
    4931,
    9043,
    1099,
    2519,
    3,
    8906,
    8906,
    8906,
    1376,
    241,
    513,
    3056,
    2344,
    686,
    5015,
    26,
    59,
    28,
    28,
    28,
    8218,
    3198,
    5764,
    5764,
    7111,
    484,
    704,
    704,
    1315,
    171,
    171,
    489,
    1387,
    59,
    28,
    28,
    28,
    28,
    28,
    28,
    28,
    3061,
    5586,
    9399,
    9399,
    508,
    41,
    41,
    3067,
    5413,
    326,
    326,
    563,
    4011,
    4011,
    7051,
    4469,
    71,
    71,
    118,
    10,
    5,
    5,
    2837,
    2651,
    5563,
    5819,
    452,
    245,
    483,
    5407,
    2908,
    2908,
    5865,
    5865,
    7821,
    529,
    3,
    59,
    28,
    28,
    27,
    28,
    28,
    28,
    107,
    107,
    223,
    266,
    10,
    10,
    230,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    65,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    206,
    1278,
    1278,
    2228,
    206,
    1278,
    2089,
    2089,
]
coarse_prompt0 = [
    835,
    738,
    408,
    408,
    408,
    408,
    408,
    62,
    62,
    62,
    62,
    62,
    717,
    62,
    717,
    62,
    62,
    62,
    404,
    11,
    323,
    666,
    984,
    735,
    428,
    977,
    428,
    977,
    977,
    793,
    11,
    428,
    428,
    679,
    20,
    428,
    862,
    1022,
    457,
    967,
    457,
    224,
    879,
    208,
    604,
    699,
    855,
    834,
    430,
    834,
    491,
    491,
    491,
    1017,
    699,
    432,
    724,
    228,
    724,
    838,
    535,
    937,
    378,
    937,
    337,
    280,
    378,
    808,
    643,
    808,
    921,
    923,
    70,
    563,
    881,
    936,
    348,
    82,
    222,
    695,
    222,
    695,
    923,
    833,
    378,
    755,
    81,
    586,
    783,
    276,
    1011,
    676,
    409,
    798,
    531,
    479,
    479,
    465,
    457,
    770,
    324,
    977,
    770,
    324,
    843,
    821,
    148,
    148,
    237,
    563,
    893,
    551,
    846,
    413,
    939,
    505,
    976,
    276,
    323,
    73,
    95,
    73,
    323,
    187,
    863,
    306,
    699,
    699,
    699,
    879,
    472,
    472,
    472,
    602,
    488,
    666,
    666,
    192,
    162,
    695,
    870,
    162,
    695,
    501,
    983,
    325,
    370,
    370,
    73,
    11,
    868,
    316,
    224,
    310,
    925,
    269,
    846,
    422,
    233,
    695,
    830,
    112,
    253,
    253,
    253,
    253,
    155,
    1001,
    91,
    91,
    52,
    370,
    904,
    904,
    904,
    311,
    875,
    131,
    583,
    583,
    699,
    432,
    876,
    1017,
    738,
    738,
    738,
    738,
    408,
    696,
    863,
    6,
    82,
    132,
    771,
    846,
    99,
    233,
    501,
    961,
    694,
    504,
    755,
    694,
    413,
    413,
    690,
    971,
    472,
    472,
    347,
    904,
    904,
    904,
    904,
    855,
    855,
    106,
    738,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    62,
    62,
    738,
    408,
    408,
    408,
    408,
    62,
    62,
    62,
    62,
    121,
    121,
    62,
    717,
    62,
    62,
    62,
    717,
    62,
    62,
    62,
    62,
    62,
    121,
    121,
    62,
    62,
    62,
    62,
    23,
    283,
    727,
    1000,
    944,
    944,
    563,
    491,
    687,
    1001,
    563,
    858,
    760,
    921,
    796,
    457,
    629,
    699,
    347,
    347,
    404,
    404,
    393,
    499,
    499,
    73,
    499,
    73,
    392,
    198,
    348,
    392,
    491,
    583,
    612,
    656,
    808,
    291,
    890,
    583,
    491,
    583,
    523,
    191,
    612,
    912,
    283,
    407,
    655,
    563,
    433,
    574,
    438,
    438,
    438,
    148,
    237,
    433,
    986,
    846,
    162,
    747,
    747,
    984,
    850,
    20,
    850,
    984,
    984,
    984,
    825,
    868,
    751,
    255,
    530,
    499,
    438,
    47,
    438,
    148,
    148,
    148,
    148,
    160,
    148,
    148,
    148,
    148,
    148,
    237,
    819,
    592,
    980,
    582,
    850,
    770,
    328,
    850,
    770,
    328,
    987,
    561,
    921,
    698,
    561,
    253,
    324,
    185,
    755,
    324,
    11,
    987,
    424,
    306,
    323,
    404,
    91,
    91,
    472,
    323,
    145,
    103,
    276,
    276,
    445,
    796,
    871,
    491,
    491,
    347,
    724,
    627,
    643,
    551,
    820,
    820,
    937,
    937,
    43,
    582,
    413,
    457,
    433,
    237,
    574,
    438,
    148,
    148,
    148,
    148,
    148,
    148,
    148,
    148,
    463,
    463,
    463,
    463,
    339,
    339,
    339,
    339,
    835,
    835,
    835,
    408,
    408,
    408,
    738,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    408,
    62,
    62,
    717,
    62,
    121,
    62,
    62,
    62,
    62,
    717,
    62,
    62,
    62,
    62,
    62,
    717,
    62,
    62,
    62,
    121,
    62,
    121,
    62,
    717,
    62,
    62,
    62,
]
coarse_prompt1 = [
    913,
    1007,
    424,
    518,
    913,
    913,
    913,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    928,
    330,
    386,
    984,
    961,
    961,
    534,
    15,
    717,
    244,
    386,
    713,
    663,
    180,
    509,
    505,
    503,
    800,
    946,
    745,
    373,
    942,
    516,
    969,
    42,
    483,
    419,
    646,
    601,
    765,
    516,
    516,
    959,
    651,
    363,
    937,
    326,
    937,
    601,
    564,
    544,
    293,
    899,
    265,
    67,
    385,
    443,
    375,
    443,
    685,
    685,
    683,
    703,
    985,
    414,
    381,
    351,
    947,
    478,
    95,
    478,
    478,
    503,
    958,
    512,
    351,
    955,
    453,
    955,
    663,
    953,
    205,
    812,
    560,
    653,
    928,
    750,
    293,
    556,
    827,
    351,
    782,
    14,
    838,
    213,
    364,
    351,
    381,
    926,
    926,
    133,
    835,
    534,
    610,
    45,
    482,
    591,
    351,
    995,
    371,
    504,
    770,
    648,
    747,
    200,
    368,
    693,
    838,
    683,
    937,
    743,
    1007,
    601,
    743,
    6,
    994,
    580,
    1007,
    961,
    652,
    774,
    478,
    478,
    478,
    185,
    955,
    482,
    430,
    969,
    961,
    282,
    92,
    775,
    656,
    828,
    559,
    577,
    955,
    796,
    154,
    30,
    955,
    955,
    213,
    213,
    198,
    213,
    185,
    198,
    373,
    752,
    924,
    969,
    772,
    969,
    969,
    371,
    693,
    769,
    763,
    477,
    1021,
    114,
    114,
    859,
    601,
    601,
    937,
    913,
    913,
    424,
    723,
    478,
    478,
    95,
    52,
    95,
    47,
    955,
    403,
    179,
    665,
    330,
    330,
    22,
    6,
    628,
    22,
    580,
    872,
    422,
    519,
    580,
    519,
    519,
    580,
    371,
    580,
    913,
    913,
    913,
    424,
    518,
    518,
    518,
    518,
    518,
    518,
    424,
    424,
    518,
    518,
    518,
    913,
    544,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    756,
    838,
    164,
    385,
    815,
    303,
    483,
    416,
    673,
    351,
    385,
    478,
    478,
    955,
    955,
    717,
    942,
    942,
    195,
    504,
    960,
    960,
    960,
    956,
    961,
    697,
    697,
    898,
    505,
    886,
    84,
    815,
    897,
    266,
    815,
    185,
    478,
    962,
    763,
    829,
    114,
    679,
    42,
    365,
    478,
    955,
    179,
    838,
    588,
    838,
    226,
    926,
    133,
    133,
    133,
    743,
    176,
    580,
    708,
    368,
    814,
    668,
    122,
    386,
    593,
    870,
    593,
    665,
    512,
    37,
    814,
    730,
    85,
    897,
    619,
    806,
    133,
    133,
    114,
    926,
    747,
    926,
    913,
    974,
    646,
    646,
    747,
    646,
    646,
    646,
    974,
    245,
    245,
    717,
    259,
    37,
    37,
    449,
    241,
    386,
    630,
    503,
    774,
    809,
    846,
    365,
    478,
    665,
    955,
    375,
    600,
    15,
    433,
    67,
    218,
    859,
    741,
    114,
    741,
    285,
    92,
    106,
    580,
    580,
    429,
    67,
    105,
    651,
    317,
    564,
    960,
    994,
    392,
    392,
    392,
    392,
    392,
    403,
    67,
    503,
    405,
    106,
    692,
    133,
    926,
    752,
    747,
    747,
    926,
    646,
    993,
    913,
    646,
    646,
    747,
    747,
    974,
    646,
    974,
    913,
    913,
    646,
    652,
    652,
    913,
    424,
    518,
    518,
    544,
    424,
    424,
    518,
    518,
    518,
    518,
    518,
    518,
    518,
    544,
    544,
    518,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    424,
    518,
    424,
    424,
    518,
    518,
]

coarse_tokens = [
    [
        121,
        62,
        62,
        62,
        62,
        717,
        11,
        11,
        233,
        233,
        59,
        233,
        280,
        162,
        162,
        233,
        233,
        222,
        162,
        747,
        233,
        987,
        658,
        457,
        1011,
        751,
        1004,
        561,
        23,
        344,
        561,
        1004,
        1010,
        530,
        976,
        404,
        738,
        106,
        738,
        408,
        408,
        408,
        738,
        738,
        408,
        408,
        738,
        738,
        738,
        738,
        408,
        62,
        408,
        408,
        62,
        62,
        62,
        62,
        408,
        62,
        717,
        408,
        738,
        876,
        432,
        491,
        604,
        432,
        491,
        604,
        432,
        834,
        1019,
        738,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        62,
        121,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        121,
        717,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        408,
        738,
        876,
        604,
        699,
        699,
        699,
        699,
        432,
        957,
        559,
        1000,
        643,
        458,
        584,
        939,
        676,
        574,
        47,
        438,
        148,
        148,
        176,
        472,
        943,
        657,
        727,
        191,
        801,
        229,
        237,
        985,
        782,
        233,
        650,
        612,
        699,
        699,
        228,
        475,
        472,
        25,
        115,
        574,
        488,
        73,
        499,
        677,
        73,
        275,
        846,
        747,
        280,
        950,
        457,
        753,
        438,
        438,
        438,
        148,
        148,
        176,
        176,
        339,
        106,
        339,
        835,
        176,
        488,
        887,
        73,
        73,
        358,
        747,
        747,
        411,
        112,
        747,
        747,
        411,
        505,
        753,
        779,
        779,
        779,
        904,
        472,
        323,
        537,
        148,
        148,
        148,
        148,
        148,
        463,
        339,
        835,
        339,
        148,
        148,
        25,
        835,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        408,
        62,
        62,
        408,
        62,
        62,
        62,
        62,
        717,
        62,
        717,
        121,
        62,
        121,
        121,
        62,
        62,
        62,
        62,
        717,
        62,
        62,
        62,
        121,
        62,
        62,
        121,
        62,
        62,
        717,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        62,
        717,
        62,
        121,
        62,
        62,
        62,
        717,
        62,
        62,
        62,
        62,
    ],
    [
        518,
        424,
        424,
        518,
        424,
        424,
        561,
        534,
        849,
        806,
        665,
        577,
        955,
        955,
        791,
        577,
        216,
        955,
        503,
        921,
        787,
        955,
        955,
        185,
        581,
        213,
        654,
        37,
        858,
        955,
        37,
        351,
        229,
        37,
        969,
        942,
        114,
        969,
        913,
        424,
        424,
        518,
        114,
        544,
        424,
        518,
        114,
        114,
        942,
        544,
        518,
        424,
        518,
        913,
        424,
        424,
        424,
        424,
        913,
        424,
        424,
        518,
        404,
        765,
        114,
        959,
        942,
        404,
        975,
        404,
        601,
        942,
        601,
        913,
        424,
        518,
        518,
        424,
        424,
        518,
        518,
        518,
        518,
        913,
        518,
        913,
        913,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        518,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        518,
        700,
        765,
        404,
        404,
        835,
        937,
        917,
        937,
        959,
        1014,
        293,
        179,
        179,
        838,
        368,
        67,
        819,
        219,
        819,
        819,
        960,
        133,
        974,
        722,
        722,
        722,
        722,
        492,
        67,
        351,
        403,
        722,
        991,
        722,
        722,
        722,
        722,
        722,
        722,
        722,
        961,
        974,
        926,
        734,
        893,
        580,
        228,
        166,
        363,
        787,
        503,
        406,
        406,
        406,
        961,
        961,
        819,
        819,
        926,
        928,
        420,
        646,
        961,
        652,
        913,
        424,
        974,
        580,
        580,
        580,
        928,
        498,
        600,
        534,
        561,
        497,
        861,
        534,
        787,
        708,
        43,
        961,
        961,
        212,
        422,
        43,
        956,
        819,
        819,
        819,
        926,
        646,
        646,
        819,
        974,
        974,
        974,
        993,
        974,
        974,
        519,
        1007,
        518,
        518,
        518,
        518,
        518,
        518,
        518,
        913,
        424,
        424,
        913,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        424,
        518,
        424,
        424,
        424,
        424,
        518,
        424,
        424,
        424,
        424,
        518,
        424,
        424,
    ],
]

torch.manual_seed(42)

prompt_path = "/Users/hao/Desktop/ML/bark/bark/assets/prompts/v2/en_speaker_6.npz"


def test_generate_audio():
    text = " this is a test text"
    semantic_tokens = generate_audio(text, prompt_path)

    print(semantic_tokens)


def test_generate_coarse():
    semantic = torch.tensor(semantic_tokens)
    history_prompt = BarkPrompt(
        torch.tensor(semantic_prompt),
        torch.tensor([coarse_prompt0, coarse_prompt1]),
        torch.tensor([]),
    )

    coarse_tokens = generate_coarse_tokens_from_semantic(
        semantic[0], history_prompt, **asdict(generation_config)
    )

    print(coarse_tokens)


def test_generate_fine():
    prompt = load_bark_audio_prompt(prompt_path)

    fine_tokens = generate_fine_tokens_from_coarse(
        torch.tensor(coarse_tokens),
        prompt,
    )

    print(fine_tokens)


if __name__ == "__main__":
    test_generate_fine()


#       ([[ 121,   62,   62,  ...,   62,   62,   62],
#         [ 518,  424,  424,  ...,  518,  424,  424],
#         [ 937,   36,   36,  ...,  290,   36,  678],
#         ...,
#         [ 939,  986,  986,  ...,  129,  701,  881],
#         [ 900, 1002,  570,  ...,  722,  853, 1002],
#         [ 518,  948,  948,  ...,  499,  899,  975]]
